/*

    Copyright © 2016-2017 Dominique Climent, Florian Dubath

    This file is part of Monnaie-Leman Wallet.

    Monnaie-Leman Wallet is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Monnaie-Leman Wallet is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Monnaie-Leman Wallet.  If not, see <http://www.gnu.org/licenses/>.

*/
'use strict';

// tests are adapted from https://github.com/TooTallNate/node-plist

var path = require('path');
var nodeunit = require('nodeunit');
var bplist = require('../');

module.exports = {
  'iTunes Small': function (test) {
    var file = path.join(__dirname, "iTunes-small.bplist");
    var startTime1 = new Date();

    bplist.parseFile(file, function (err, dicts) {
      if (err) {
        throw err;
      }

      var endTime = new Date();
      console.log('Parsed "' + file + '" in ' + (endTime - startTime1) + 'ms');
      var dict = dicts[0];
      test.equal(dict['Application Version'], "9.0.3");
      test.equal(dict['Library Persistent ID'], "6F81D37F95101437");
      test.done();
    });
  },

  'sample1': function (test) {
    var file = path.join(__dirname, "sample1.bplist");
    var startTime = new Date();

    bplist.parseFile(file, function (err, dicts) {
      if (err) {
        throw err;
      }

      var endTime = new Date();
      console.log('Parsed "' + file + '" in ' + (endTime - startTime) + 'ms');
      var dict = dicts[0];
      test.equal(dict['CFBundleIdentifier'], 'com.apple.dictionary.MySample');
      test.done();
    });
  },

  'sample2': function (test) {
    var file = path.join(__dirname, "sample2.bplist");
    var startTime = new Date();

    bplist.parseFile(file, function (err, dicts) {
      if (err) {
        throw err;
      }

      var endTime = new Date();
      console.log('Parsed "' + file + '" in ' + (endTime - startTime) + 'ms');
      var dict = dicts[0];
      test.equal(dict['PopupMenu'][2]['Key'], "\n        #import <Cocoa/Cocoa.h>\n\n#import <MacRuby/MacRuby.h>\n\nint main(int argc, char *argv[])\n{\n  return macruby_main(\"rb_main.rb\", argc, argv);\n}\n");
      test.done();
    });
  },

  'airplay': function (test) {
    var file = path.join(__dirname, "airplay.bplist");
    var startTime = new Date();

    bplist.parseFile(file, function (err, dicts) {
      if (err) {
        throw err;
      }

      var endTime = new Date();
      console.log('Parsed "' + file + '" in ' + (endTime - startTime) + 'ms');

      var dict = dicts[0];
      test.equal(dict['duration'], 5555.0495000000001);
      test.equal(dict['position'], 4.6269989039999997);
      test.done();
    });
  },

  'utf16': function (test) {
    var file = path.join(__dirname, "utf16.bplist");
    var startTime = new Date();

    bplist.parseFile(file, function (err, dicts) {
      if (err) {
        throw err;
      }

      var endTime = new Date();
      console.log('Parsed "' + file + '" in ' + (endTime - startTime) + 'ms');

      var dict = dicts[0];
      test.equal(dict['CFBundleName'], 'sellStuff');
      test.equal(dict['CFBundleShortVersionString'], '2.6.1');
      test.equal(dict['NSHumanReadableCopyright'], '©2008-2012, sellStuff, Inc.');
      test.done();
    });
  },

  'uid': function (test) {
    var file = path.join(__dirname, "uid.bplist");
    var startTime = new Date();

    bplist.parseFile(file, function (err, dicts) {
      if (err) {
        throw err;
      }

      var endTime = new Date();
      console.log('Parsed "' + file + '" in ' + (endTime - startTime) + 'ms');

      var dict = dicts[0]; 
      test.deepEqual(dict['$objects'][1]['NS.keys'], [2, 3, 4]);
      test.deepEqual(dict['$objects'][1]['NS.objects'], [5, 6, 7]);
      test.equal(dict['$top']['root'], 1);      
      test.done();
    });
  }
};
